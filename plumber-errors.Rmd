# How can I handle API errors?

**Learning objectives:**

-   Describe how {plumber} handles errors by default.
-   Log API errors separately from client error responses.
-   Describe the possible responses from an endpoint.
-   Return useful error responses from an endpoint.

## Plumber's default error handling {-}

```{r plumber-errors-default, eval = FALSE}
#* @get /simple
function(){
  stop("I'm an error!")
}

#> {"error":["500 - Internal server error"],"message":["Error in (function () : 
#> I'm an error!\n"]}
```

-   HTTP status code 500 for all errors
-   Error sent to client
-   Error also printed in terminal

## Responses in plumber block {-}

```{r plumber-output-response-annotation, eval = FALSE}
#* @response 200 The number of things in the whatever.
#* @response 400 Bad request. This usually occurs because of a missing or 
#*   malformed parameter.
#* @response 401 Unauthorized. A valid API token was not provided.
```

-   `@response` `Status Code` `Description`
-   Can *only* give description (not object details)
-   *Be careful!* Not validated
-   More in API errors section

## Serializers {-}

-   Vocab: "Serialize" = "translate into a format for storage or transmission"
-   Default = `json` via `jsonlite::toJSON()`
-   `#* @serializer NAME list(ARGS)`
    -   eg, `#* @serializer json list(na = "string")`
-   Impacts behavior *AND* Swagger docs

## Structured text {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|`json` (default)|`jsonlite::toJSON()`|`application/json`|
|`unboxedJSON`|<code>jsonlite::toJSON(<br>&nbsp;&nbsp;auto_unbox = TRUE)</code>|`application/json`|
|`geojson`|`geojsonsf::sfc_geojson()` or `geojsonsf::sf_geojson()`|`application/json`|
|`yaml`|`yaml::as_yaml()`|`text/x-yaml`|
|`csv`|`readr::format_csv`|`text/csv`|
|`tsv`|`readr::format_tsv`|`text/tab-separated-values`|

## Larger data {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|rds|`base::serialize()`|`application/rds`|
|feather|`arrow::write_feather()`|`application/vnd.apache.arrow.file`|
|parquet|`arrow::write_parquet()`|`application/parquet`|

## HTML & XML {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|`html`|(unprocessed)|`text/html; charset=UTF-8`|
|`htmlwidget`|`htmlwidgets::saveWidget()`|`text/html; charset=UTF-8`|

Use `html` for `xml`-structured data, too

## Plain text {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|`text`|`as.character()`|`text/plain`|
|`format`|`format()`|`text/plain`|
|`print`|`print()`|`text/plain`|
|`cat`|`cat()`|`text/plain`|

## Devices (images & PDFs) {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|`jpeg`|`jpeg()`|`image/jpeg`|
|`png`|`png()`|`image/png`|
|`svg`|`svg()`|`image/svg+xml`|
|`tiff`|`tiff()`|`image/tiff`|
|`bmp`|`bmp()`|`image/bmp`|
|`pdf`|`pdf()`|`application/pdf`|

Can define new image serializers with `serializer_device()`

## Other things {-}

|`@serializer`|processed with|content type|
|-------------|--------------|------------|
|contentType|(user-specified)|(user-specified)|
|octet|(as is, must be `raw`)|`application/octet-stream`|


```{r plumber-output-serializer-contentType, eval = FALSE}
#* @serializer contentType list(type = "application/protobuf", serialize_fn = protolite::serialize_pb)
```

-   `octet` is `contentType` with a `serialize_fn` that checks `is.raw()`

## API errors {-}

***API errors are responses***

-   Status code specifies broad error category (see next slide)
-   Best practice: Error format same as successful response
    -   Be careful about this, don't make silent errors easy!
-   Need `plumber::pr_handle()` family for advanced options

## HTTP error status codes



|code|title|uses|
|400|Bad Request||


## Programmatic responses {-}

-   Can specify full OpenAPI Response Object programmatically
-   Impacts auto-generated Swagger documentation
-   Not well documented (outside of this book)

```{r plumber-output-response-programmatic, eval = FALSE}
pr_get(
  "/pathToEndpoint", function(res, req) { ... },
  responses = list(
    "403" = list(
      description = "Forbidden",
      content = list("application/json" = list())
    )
  )
)
```


## Setting unencrypted cookies {-}

## Setting encrypted cookies {-}


## Meeting Videos {-}

### Cohort 1 {-}

`r knitr::include_url("https://www.youtube.com/embed/URL")`

<details>
<summary> Meeting chat log </summary>

```
LOG
```
</details>
